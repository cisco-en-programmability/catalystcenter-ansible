---
- name: Play
  hosts: localhost
  vars_files:
    - credentials.yml
    - device_details.template
  gather_facts: false
  connection: local
  tasks:
    #
    # Project Info  Section
    #
    - name: Test project template
      cisco.catalystcenter.template_intent:
        catalystcenter_host: "{{ catalystcenter_host }}"
        catalystcenter_port: "{{ catalystcenter_port }}"
        catalystcenter_username: "{{ catalystcenter_username }}"
        catalystcenter_password: "{{ catalystcenter_password }}"
        catalystcenter_verify: "{{ catalystcenter_verify }}"
        catalystcenter_debug: "{{ catalystcenter_debug }}"
        catalystcenter_log: true
        state: "merged"
        config_verify: true
        # ignore_errors: true        # Enable this to continue execution even the task fails
        config:
          - configuration_templates:
              project_name: "{{ item.proj_name }}"
              template_name: "{{ item.temp_name }}"
              template_content: "{{ item.device_config }}"
              version_description: "{{ item.description }}"
              language: "{{ item.language }}"
              software_type: "{{ item.type }}"
              software_variant: "{{ item.variant }}"
              device_types:
                - product_family: "{{ item.family }}"
      register: template_result
      with_items: '{{ template_details }}'
      tags:
        - template
    - name: Create pnp
      cisco.catalystcenter.pnp_intent:
        catalystcenter_host: "{{ catalystcenter_host }}"
        catalystcenter_username: "{{ catalystcenter_username }}"
        catalystcenter_password: "{{ catalystcenter_password }}"
        catalystcenter_verify: "{{ catalystcenter_verify }}"
        catalystcenter_port: "{{ catalystcenter_port }}"
        catalystcenter_debug: "{{ catalystcenter_debug }}"
        catalystcenter_log: true
        config:
          - site_name: "{{ item.site_name }}"
            project_name: "{{ item.proj_name }}"
            template_name: "{{ item.temp_name }}"
            image_name: "{{ item.image_name }}"
            device_info:
              - serial_number: "{{ item.device_number }}"
                hostname: "{{ item.device_name }}"
                state: "{{ item.device_state }}"
                pid: "{{ item.device_id }}"
      register: pnp_result
      with_items: '{{ device_details }}'
      tags:
        - pnp
